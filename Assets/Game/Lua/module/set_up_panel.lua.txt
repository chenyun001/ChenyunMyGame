---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by zhaomingwang.
--- DateTime: 2021/10/30 7:52 下午
---


--[[********************************************************************* 
Copyright (C) 2020     mailingjoy 
File Name:             information_panel.lua.txt
Author:                qiaoxiaokai 
CreateTime:            2020/7/27 9:39:15
*********************************************************************--]]
local event_system = require "manager/event"
local role_model = lua_framework.proxy.player_info_proxy
require("services/mj_account_service")

local meta = typesys.def.SetUpPanel{
    __super = typesys.Panel,
    user_name_text =  typesys.__unmanaged,
    back_btn = typesys.__unmanaged,
    head_info_bar_image =typesys.__unmanaged,
    exp_value_text =  typesys.__unmanaged,
    area_text = typesys.__unmanaged,
    id_text = typesys.__unmanaged,
    head_portrait_image = typesys.__unmanaged,
    music_slider = typesys.__unmanaged,
    sound_slider = typesys.__unmanaged,
    logout_btn = typesys.__unmanaged,
    honor_value_text=typesys.__unmanaged,
    btn_delete_account = typesys.__unmanaged,
    Button_change_head = typesys.__unmanaged,
    head_fame = typesys.__unmanaged,
}


local user_name_text = "Info_content_container/Info_name_container/Info_name_text"
local back_btn = "Info_content_container/Common_F/BtnBack"
local head_info_bar_image = "Info_content_container/HeadInfoBar/HeadInfoBarImage"
local exp_value_text = "Info_content_container/HeadInfoBar/ExpValueText"
local area_text = "Info_content_container/Info_server/Area_text"
local id_text = "Info_content_container/Info_ID/ID_text"
local head_portrait_image = "Info_content_container/HeadInfo/HeadFrame_image/HeadPortrait_image"
local music_slider = "Info_content_container/SoundEffectMusic/Music/Slider"
local sound_slider = "Info_content_container/SoundEffectMusic/SoundEffect/Slider"
local honor_value_text = "Info_content_container/HonorValue/HonorValue_text"
local logout_btn = "Info_content_container/LogoutBtn"

function meta:awake()
    ---@type UIText
    self.user_name_text = self.transform:Find(user_name_text):GetComponent(typeof(UnityEngine.UI.Text))
    ---@type UIButton
    self.back_btn = self.transform:Find(back_btn):GetComponent(typeof(UnityEngine.UI.Button))

    ---@type UIImage
    self.head_info_bar_image = self.transform:Find(head_info_bar_image):GetComponent(typeof(UnityEngine.UI.Image))

    self.exp_value_text = self.transform:Find(exp_value_text):GetComponent(typeof(CS.TMPro.TextMeshProUGUI))
    ---@type UIText
    self.area_text = self.transform:Find(area_text):GetComponent(typeof(UnityEngine.UI.Text))
    ---@type UIText
    self.id_text = self.transform:Find(id_text):GetComponent(typeof(UnityEngine.UI.Text))
    self.honor_value_text = self.transform:Find(honor_value_text):GetComponent(typeof(CS.TMPro.TextMeshProUGUI))
    ---@type UIImage
    self.head_portrait_image = self.head_portrait_image.transform:GetComponent(typeof(UnityEngine.UI.Image))
    self.music_slider = self.transform:Find(music_slider):GetComponent(typeof(UnityEngine.UI.Slider))
    self.sound_slider = self.transform:Find(sound_slider):GetComponent(typeof(UnityEngine.UI.Slider))
    self.logout_btn = self.transform:Find(logout_btn):GetComponent(typeof(UnityEngine.UI.Button))
    local back_volume = UnityEngine.PlayerPrefs.GetFloat("AudioBackgroundVolume")
    local effect_volume = UnityEngine.PlayerPrefs.GetFloat("AudioEffectVolume")
    self.music_slider.value = back_volume
    self.sound_slider.value = effect_volume
    self.head_fame = self.head_fame.transform:GetComponent(typeof(UnityEngine.UI.Image))
    self.btn_delete_account.onClick:AddListener(function()
        MessageBox.Show(1|2, language_data.GetLanguage("IDZhuxiaoJinggao"), function(type)
            if (type==1) then
                local msg = {}
                msg.proto = "proto.gm.GmRequest"
                msg.str = "ban "..role_model.RoleId.." 8000000"
                network.send(EchoCmd.Gm,msg)
                
                typesys.new(typesys.AccountService):delete_account()
            end
        end,"注销",language_data.GetLanguage("cancel"))
        
        
    end)
end

function meta:start()

    self:add_listener()
    self:init_info()
end

function meta:add_listener()
    self.back_btn.onClick:AddListener(
            function()
                self:pop_panel()
            end)

    self.logout_btn.onClick:AddListener(
            function()
                
            
                network.log_out()
                lua_framework.proxy:clear()
                self:pop_panel()
                GameUIManager:CloseUI(typeof(MailingJoy.Game.Modules.Common.SetUpPanel))
                GameUIManager:CloseUI(typeof(MailingJoy.Game.Modules.Main.MainPanel))
                --Facade:SendNotification("BATTLE","10000101")
                -- 关闭开始游戏加载界面
                GameUIManager:OpenUI(typeof(MailingJoy.Game.Modules.PlayGame.PlayGame))
            end)
   
    self.music_slider.onValueChanged:AddListener(
            function(value)
                self:music_adjust(value)
            end)
    self.sound_slider.onValueChanged:AddListener(
            function(value)
                self:sound_adjust(value)
            end)
    self.Button_change_head.onClick:AddListener(
        function()
            GameUIManager:OpenUI("HeadSetUp.prefab")
        end)
    event_system:add_listener(NetWorkEvent.SET_HEAD_INFO, function()
        self:Fresh()
    end)  
end

function meta:init_info()

    local excel = roleLevelData:get_excel(role_model.level)
    --self.head_portrait_image.sprite = get_sprite_from_atlas("AccountAvatar", "AvatarAtlas", "1")
    self.user_name_text.text = role_model.role_name
    self.area_text.text = CS.Core.AppConst.ServerName
    self.id_text.text = UnityEngine.PlayerPrefs.GetString("MJAccount")
    self.honor_value_text.text = role_model.level
    self.head_info_bar_image.fillAmount = role_model.exp / excel.value
    self.exp_value_text.text = string.format("%d /%d",role_model.exp,excel.value)
    self:Fresh()
end

function meta:Fresh()
    self.head_portrait_image:SetSpriteFromAtlasAsync("avatar_atlas",role_model.face)
    if role_model.headFrame == "default" then
        self.head_fame.gameObject:SetActive(false)
    else
        self.head_fame.gameObject:SetActive(true)
    end
    self.head_fame:SetSpriteFromAtlasAsync("HeadFrame",role_model.headFrame)
end

function meta:music_adjust(value)
    local volume = string.format("%.2f",value)
    volume = tonumber(volume)
    CS.MailingJoy.Core.SoundManager.Instance:SetVolume(1,volume) --1:music 2:sound(effect)
end

function meta:sound_adjust(value)
    local volume = string.format("%.2f",value)
    volume = tonumber(volume)
    CS.MailingJoy.Core.SoundManager.Instance:SetVolume(2,volume) --1:music 2:sound(effect)

end

function meta:open_military_panel()
    local  pos = {
        ["x"] = 183,
        ["y"] = 312,
    }
    ModuleManager:OpenPanel("MilitaryRankPanel",nil,pos)
end

function meta:pop_panel()
    GameUIManager:CloseUI(typeof(MailingJoy.Game.Modules.Common.SetUpPanel))

end

return meta