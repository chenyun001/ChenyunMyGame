---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Jonny.
--- DateTime: 2021/1/19 15:18
---

local game_events = require("module/game_events")
local account_proxy = lua_framework.proxy.account_proxy
local new = typesys.new
local AccountSwitch = typesys.def.AccountSwitch {
    ---@type UISubCtrl
    __super = typesys.UISubCtrl,

    tmp_account = typesys.__unmanaged,
    btn_switch = typesys.__unmanaged,
}

function AccountSwitch:start()
    self.btn_switch.enabled = false
    self:add_listeners()
end

function AccountSwitch:add_listeners()
    self.btn_switch.onClick:AddListener(function()
        self:switch_account()
    end)
    self:add_listener(game_events.account_login_success, function(...)
        self:set_account()
    end)
end

function AccountSwitch:set_account()
    local account = account_proxy:get_account()
    if (string.len(account) > 8) then
        self.tmp_account.text = string.sub(account, 6) .. "..."
    else
        self.tmp_account.text = account
    end
    self.btn_switch.enabled = true
end

function AccountSwitch:switch_account()
    -- 关闭切换按钮
    self.btn_switch.enabled = false
    self.tmp_account.text = ""

    -- 登出
    local service = new(typesys.AccountService)
    service:logout()
    GameUIManager:CloseAllUI()
    GameUIManager:OpenUI(typeof(MailingJoy.Game.Modules.PlayGame.PlayGame))
end

return AccountSwitch