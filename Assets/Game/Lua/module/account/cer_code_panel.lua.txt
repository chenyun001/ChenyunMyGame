---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Administrator.
--- DateTime: 2021/10/21 17:55
---

---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Jonny.
--- DateTime: 2021/1/14 17:16
---

local TMPro = CS.TMPro
local new = typesys.new
local delete = typesys.delete
local events = require("module/account/events")
local event_system = require "manager/event"
local id_card_check = require("module/account/cer_code_check")
local cer_code_panel = typesys.def.CerCodePanel {
    __super = typesys.Panel,
    input_account = typesys.__unmanaged,
    input_pwd = typesys.__unmanaged,
    btn_login = typesys.__unmanaged,
    btn_exit = typesys.__unmanaged,
    tmp_tips = typesys.__unmanaged,
}

function cer_code_panel:start()
    self.tmp_tips= self.tmp_tips:GetComponent(typeof(UnityEngine.UI.Text))
    self.input_pwd = self.input_pwd:GetComponent(typeof(CS.TMPro.TMP_InputField))
    self.input_account = self.input_account:GetComponent(typeof(CS.TMPro.TMP_InputField))
   
    self.btn_login.onClick:AddListener(function()
        -- 前往登录界面
        self:on_register()
    end)
    self.btn_exit.onClick:AddListener(function()
        self:on_exit()
    end)
    self:add_listeners()

    if (isEditor) then
        local service = new(typesys.AccountService)
        service:cer_code("19880113")
    end
end

---add_listeners 添加事件监听
function cer_code_panel:add_listeners()
    self:add_listener(events.network_cer_code_response, function(...)
        self:register_cb(...)
    end)
end


function cer_code_panel:on_register()
    -- 账号转小写
    local account = string.lower(self.input_account.text)
    -- 密码区分大小写
    local password = self.input_pwd.text

    if string.len(account) == 0 then
        self.tmp_tips.text = "姓名不能为空"
        return
    end
    if id_card_check:verifyIDCard(password) ~= 1 then
        
        self.tmp_tips.text = "请填入正确的身份证号"
        return
    end
    -- 账号合法性 or 密码合法性
  
        local service = new(typesys.AccountService)
        service:cer_code(password:sub(7,14))
    self.tmp_tips.text = ""
end
function cer_code_panel:on_exit()
    -- 账号转小写
    
    MessageBox.Show(1 | 2, language_data.GetLanguage("idCardNeedCheck"), function(type)
        if(type==1) then
            Application.Quit()
            if isEditor then
                CS.UnityEditor.EditorApplication.isPlaying = false
            end
        end
         end,"退出","继续")

  
end
function cer_code_panel:register_cb(response)
    if response.errorCode == 0 then
        self.tmp_tips.text = "注册成功"
    else
        -- 出错
        self.tmp_tips.text = response.errorMsg
    end
end

return cer_code_panel