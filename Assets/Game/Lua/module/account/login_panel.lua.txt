---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Jonny.
--- DateTime: 2021/1/14 17:17
---

require("services/mj_account_service")
local new = typesys.new
local delete = typesys.delete
local TMPro = CS.TMPro
local event_system = require "manager/event"
local events = require("module/account/events")

local LoginPanel = typesys.def.LoginPanel {
    __super = typesys.UISubCtrl,
    input_account = typesys.__unmanaged,
    input_pwd = typesys.__unmanaged,
    toggle_eye = typesys.__unmanaged,
    img_eye_open = typesys.__unmanaged,
    img_eye_close = typesys.__unmanaged,
    btn_fast_register = typesys.__unmanaged,
    btn_login = typesys.__unmanaged,
    btn_goto_register = typesys.__unmanaged,
    tmp_tips = typesys.__unmanaged,
}

function LoginPanel:start()
    self.tmp_tips = self.tmp_tips:GetComponent(typeof(UnityEngine.UI.Text))
    self:set_tips("")
    self.toggle_eye = self.toggle_eye:GetComponent(typeof(UnityEngine.UI.Toggle))
    self.input_pwd = self.input_pwd:GetComponent(typeof(TMPro.TMP_InputField))
    self.input_account = self.input_account:GetComponent(typeof(TMPro.TMP_InputField))
    self.toggle_eye.onValueChanged:AddListener(function(value)
        self:show_eye(value)
    end)
    self.btn_login.onClick:AddListener(function()
        self:do_login()
    end)
    self.btn_fast_register.onClick:AddListener(function()
        self:quickly_register()
    end)
    self.btn_goto_register.onClick:AddListener(function()
        self:goto_register()
    end)

    self:add_listeners()
end

---add_listeners 添加事件监听
function LoginPanel:add_listeners()
end

function LoginPanel:set_tips(msg)
    self.tmp_tips.text = msg
end

function LoginPanel:show_eye(is_checked)
    if is_checked then
        self.img_eye_open:SetActive(false)
        self.img_eye_close:SetActive(true)

        self.input_pwd.contentType = TMPro.TMP_InputField.ContentType.Password
    else
        self.img_eye_open:SetActive(true)
        self.img_eye_close:SetActive(false)

        self.input_pwd.contentType = TMPro.TMP_InputField.ContentType.Standard
    end
    self.input_pwd:ActivateInputField()
end

---do_login 登录
function LoginPanel:do_login()
    -- 账号转小写
    local account = string.lower(self.input_account.text)
    -- 密码区分大小写
    local password = self.input_pwd.text

    if string.len(account) == 0 then
        self.tmp_tips.text = "账号不能为空"
        return
    end
    if string.len(password) == 0 then
        self.tmp_tips.text = "密码不能为空"
        return
    end
    -- 账号合法性 or 密码合法性

    if check_account_available(account)==false then
        self.tmp_tips.text = "账号不符合要求"
        return
    end
    -- 账号合法性 or 密码合法性
    if  check_pwd_available(password) then
        local service = new(typesys.AccountService)
        service:login(account, password)
        return
    end
    self.tmp_tips.text = "密码不符合要求"
end

---goto_register 前往注册
function LoginPanel:goto_register()
    event_system:dispatch(events.show_register_ui)
end

---quickly_register 快速注册
function LoginPanel:quickly_register()
    local service = new(typesys.AccountService)
    service:quickly_register()
end

return LoginPanel