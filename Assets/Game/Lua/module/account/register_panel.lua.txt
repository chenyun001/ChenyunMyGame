---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Jonny.
--- DateTime: 2021/1/14 17:16
---

local TMPro = CS.TMPro
local new = typesys.new
local delete = typesys.delete
local events = require("module/account/events")
local event_system = require "manager/event"
local RegisterPanel = typesys.def.RegisterPanel {
    __super = typesys.UISubCtrl,
    input_account = typesys.__unmanaged,
    input_pwd = typesys.__unmanaged,
    toggle_eye = typesys.__unmanaged,
    img_eye_open = typesys.__unmanaged,
    img_eye_close = typesys.__unmanaged,
    btn_login = typesys.__unmanaged,
    btn_register = typesys.__unmanaged,
    btn_exit = typesys.__unmanaged,
    tmp_tips = typesys.__unmanaged,
}

function RegisterPanel:start()
    self.tmp_tips = self.tmp_tips:GetComponent(typeof(UnityEngine.UI.Text))
    self.tmp_tips.text = ""
    self.toggle_eye = self.toggle_eye:GetComponent(typeof(UnityEngine.UI.Toggle))
    self.input_pwd = self.input_pwd:GetComponent(typeof(TMPro.TMP_InputField))
    self.input_account = self.input_account:GetComponent(typeof(TMPro.TMP_InputField))
    self.toggle_eye.onValueChanged:AddListener(function(value)
        self:show_eye(value)
    end)
    self.btn_login.onClick:AddListener(function()
        -- 前往登录界面
        self:goto_login()
    end)
    self.btn_register.onClick:AddListener(function()
        self:on_register()
    end)

    self:add_listeners()
end

---add_listeners 添加事件监听
function RegisterPanel:add_listeners()
    self:add_listener(events.network_register_response, function(...)
        self:register_cb(...)
    end)
end

function RegisterPanel:show_eye(is_checked)
    if is_checked then
        self.img_eye_open:SetActive(false)
        self.img_eye_close:SetActive(true)

        self.input_pwd.contentType = TMPro.TMP_InputField.ContentType.Password
    else
        self.img_eye_open:SetActive(true)
        self.img_eye_close:SetActive(false)

        self.input_pwd.contentType = TMPro.TMP_InputField.ContentType.Standard
    end
    self.input_pwd:ActivateInputField()
end

---goto_login 前往登录界面
function RegisterPanel:goto_login()
    event_system:dispatch(events.show_login_ui)
end

function RegisterPanel:on_register()
    -- 账号转小写
    local account = string.lower(self.input_account.text)
    -- 密码区分大小写
    local password = self.input_pwd.text

    if string.len(account) <4 then
        self.tmp_tips.text = "账号长度不足"
        return
    end
    if string.len(password) == 0 then
        self.tmp_tips.text = "密码不能为空"
        return
    end

    if check_account_available(account)==false then
        self.tmp_tips.text = "账号不符合要求"
        return
    end
    -- 账号合法性 or 密码合法性
    if  check_pwd_available(password) then
        local service = new(typesys.AccountService)
        service:register(account, password)
        return
    end

    self.tmp_tips.text = "密码不符合要求"
end

function RegisterPanel:register_cb(response)
    if response.errorCode == 0 then
        self.tmp_tips.text = "注册成功"
    else
        -- 出错
        self.tmp_tips.text = response.errorMsg
    end
end

return RegisterPanel