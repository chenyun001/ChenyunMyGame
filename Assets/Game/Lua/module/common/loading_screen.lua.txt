---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by chenyun.
--- DateTime: 2023/01/12 
--
local new = typesys.new

---@type TimerSystem
local timer = lua_framework.timer_system
local t
local GameLoad = typesys.def.GameLoad {
    __super = typesys.Panel,
    progress_bar = typesys.__unmanaged,
    tmp_progress = typesys.__unmanaged,
    progress_value = 0,
    times = 1
}

function GameLoad:awake()
    self.progress_bar = self.progress_bar:GetComponent(typeof(UnityEngine.UI.Image))
end

function GameLoad:start()
    self.times = 0
    -- self:add_listener(network.events.connected, function()
    --     self:socket_connected()
    -- end)
    -- self:add_listener(game_events.game_login_success, function()
    --     self:login_success()
    -- end)
    -- self:add_listener(game_events.wait_for_create_role, function()
    --     self:wait_for_create_role()
    -- end)
    -- self:add_listener(game_events.info_ready, function()
    --     self:get_info_success()
    -- end)
    self:start_load()
end

---start_load 开始加载
function GameLoad:start_load()
    DoTweenBridge.To(0, 40, 2, function(value)
        self:set_progress(value)
        GameUIManager:CloseUI("PlayGame.prefab")
    end, function()
        self:get_info_success()
    end)
end

function GameLoad:connect()
    -- 连接 socket
    local service = new(typesys.ConnectServerService)
    service:connect(self._gate_address, self._gate_port)
end

function GameLoad:socket_connected()
    if (t ~= nil) then
        timer:remove_timer(t)
    end
    DoTweenBridge.To(self.progress_value, 90, 1, function(value)
        self:set_progress(value)
    end, function()
        -- 请求登录
        self:request_login(0)
    end)
end

---login_success 登录成功
function GameLoad:login_success()
    DoTweenBridge.To(self.progress_value, 95, 1, function(value)
        self:set_progress(value)
    end, function()
        -- 请求玩家信息
        self:request_role_info()
    end)
end

function GameLoad:wait_for_create_role()
    DoTweenBridge.To(self.progress_value, 91, 0.1, function(value)
        self:set_progress(value)
    end, function()
        -- 请求玩家信息
        --self:request_role_info()
    end)

end

function GameLoad:get_info_success()
    DoTweenBridge.To(self.progress_value, 100, 1, function(value)
        self:set_progress(value)
    end, function()
        self:complete()
    end)
end

function GameLoad:request_role_info()
    ---@type PlayerInfoService
    local info_service = new(typesys.PlayerInfoService)
    info_service:request()
    info_service:request_lord_info()    
end

function GameLoad:request_login(type)
    self.times = self.times + 1
    ---@type LoginService
    local login_service = new(typesys.LoginService)
    login_service:request(type)
end

function GameLoad:set_progress(value)
    self.progress_value = value
    self.progress_bar.fillAmount = value / 100.0
    self.tmp_progress.text = string.format("%.2f%%", value)
end

function GameLoad:complete()
    -- test 进入主城
    GameUIManager:OpenUI("mainScreen.prefab")
    GameUIManager:CloseUI("LoadingScreen.prefab")
end

return GameLoad