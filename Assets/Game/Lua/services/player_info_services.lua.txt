---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Jonny.
--- DateTime: 2021/1/28 14:28
---

local new = typesys.new
local rapidjson = require 'rapidjson'
local http_util = require "manager/http"
local game_events = require("module/game_events")
local event_system = require "manager/event"
---@class PlayerInfoService
local PlayerInfoService = typesys.def.PlayerInfoService {}
---@type PlayerInfoProxy
local player_info_proxy = lua_framework.proxy.player_info_proxy
function PlayerInfoService:logIn()
    GameUIManager:OpenUI("NetLoading.prefab")
    local url = HTTP_SERVER_URL.."/jmp/reg_login/uuid"
    local data = {}
    data.udid =   CS.MailingJoy.Game.AppConst.deviceUniqueIdentifier 
    data = rapidjson.encode(data)
    local function CallBack(resoult)
        local res = rapidjson.decode(resoult)
        if res.code == 200 then
            player_info_proxy.token = res.data.token
            event_system:dispatch(NetWorkEvent.LOGIN)
        end
        
        local timer = lua_framework.timer_system
        timer:add_timer(0.5, function()
            GameUIManager:CloseUI("NetLoading.prefab")
        end)

        
    end
    local function _TimeOut_CB()
         -- todo
         local function _CallBack()
            http_util.post_json(url,CallBack,data,_TimeOut_CB,_ErrorCode)
         end
         local param = PanelParam.Create()
         local msg = {}
         msg.callbak = _CallBack
         param.Obj = msg
         GameUIManager:OpenUI("MassageTips.prefab",param)
    end

    local function _ErrorCode()

    end

    http_util.post_json(url,CallBack,data,_TimeOut_CB,_ErrorCode)
end


function PlayerInfoService:SendResoult(count)
    GameUIManager:OpenUI("NetLoading.prefab")
    local url = HTTP_SERVER_URL.."/jmp/game/settle"
    local data = {}
    data.newPoint =  count
    data = rapidjson.encode(data)
    local function CallBack(resoult)
        local res = rapidjson.decode(resoult)
        if res.code == 200 then
            player_info_proxy.rankIndex = res.data.rankIndex
            event_system:dispatch(NetWorkEvent.Resoult)
        end

        local timer = lua_framework.timer_system
        timer:add_timer(0.5, function()
            GameUIManager:CloseUI("NetLoading.prefab")
        end)

    end
    local function _TimeOut_CB()
         -- todo
         local function _CallBack()
            http_util.post_json(url,CallBack,data,_TimeOut_CB,_ErrorCode,player_info_proxy.token)
         end
         local param = PanelParam.Create()
         local msg = {}
         msg.callbak = _CallBack
         param.Obj = msg
         GameUIManager:OpenUI("MassageTips.prefab",param)
    end
    local function _ErrorCode()

    end
    http_util.post_json(url,CallBack,data,_TimeOut_CB,_ErrorCode,player_info_proxy.token)
end













