---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Jonny.
--- DateTime: 2021/2/4 9:32 下午
---



---@class GameManager 游戏管理器
local GameManager = typesys.def.GameManager {
    ---@type number 服务器时间
    _server_time = 0,
    time_check = false,
    Player  = typesys.__unmanaged,
    CombatEffectsManager = typesys.__unmanaged,
}
local event_system = require "manager/event"

function GameManager:__ctor()
    event_system:add_listener(CS.NotifyTypeConst.NetWorkError,function()
        MessageTips.Show("网络链接异常，请检查网络链接")
        GameUIManager:CloseAllUI()
        GameUIManager:OpenUI(typeof(MailingJoy.Game.Modules.PlayGame.PlayGame))
    end)
end

function GameManager:tick(delta_time)
    self._server_time = self._server_time + delta_time*1000
end

function GameManager:get_server_time()
    return self._server_time
end
---set_server_time 设置当前服务器时间
---@param t number
function GameManager:set_server_time(t)
    self._server_time = t
end

function GameManager:check_can_play(old)
    local old_type = ""
    if (old<8) then
        old_type = "_1"
    elseif old<16 then 
        old_type = "_2"
    else 
        old_type = "_3"
    end
    if (self.time_check ==true)then
        local table = os.date("*t",Convert.ToInt64(self._server_time/1000))
        if (table.wday ==1 or table.wday==6 or table.wday ==7) then
            if (table.hour == 20) then
                MessageBox.Show(1, language_data.GetLanguage("fangchenmiTime".. old_type,60-table.min), function(type)
                end,language_data.GetLanguage("ok"),language_data.GetLanguage("cancel"))
                lua_framework.timer_system:add_timer((60-table.min)*60-59, function()
                    self:close_in_one_minute()
                end)
            else
                MessageBox.Show(1, language_data.GetLanguage("fcmTime".. old_type), function(type)
                    self:close_game()
                end,language_data.GetLanguage("退出登录"),language_data.GetLanguage("关闭游戏"))
            end
        else
            MessageBox.Show(1, language_data.GetLanguage("fcmTime".. old_type), function(type)
                self:close_game()
            end,language_data.GetLanguage("退出登录"),language_data.GetLanguage("关闭游戏"))
        end
    end
end




function GameManager:close_in_one_minute()

    local msg = {}
    msg.text = "<color=#ff0000>今日游戏时间即将结束，系统将在1分钟内关闭</color>"
    msg.priority = 0
    event_system:dispatch(NetWorkEvent.RollingNotice,msg)
        lua_framework.timer_system:add_timer(60, function()
            self:close_game()
            MessageTips.Show(language_data.GetLanguage("今日未成年人可游戏时间已结束"))
        end)
end

function GameManager:close_game()
    network.log_out()
    lua_framework.proxy:clear_with_out_account()
    GameUIManager:CloseAllUI()
    GameUIManager:OpenUI(typeof(MailingJoy.Game.Modules.PlayGame.PlayGame))
end



return GameManager








